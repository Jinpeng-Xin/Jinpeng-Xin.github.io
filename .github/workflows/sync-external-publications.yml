name: Sync External Repo to Publications Root
on:
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动同步
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆主博客仓库
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 同步外部私有仓库的文件（不变）
      - name: Sync external notes/publications to _publications/
        run: |
          GITHUB_USERNAME="Jinpeng-Xin"
          EXTERNAL_REPO_NAME="jinpeng-xin"
          EXTERNAL_BRANCH="main"
          EXTERNAL_FOLDER="src/site/notes/publications/"
          TARGET_FOLDER="../_publications/"

          EXTERNAL_REPO_URL="https://${GITHUB_USERNAME}:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/${GITHUB_USERNAME}/${EXTERNAL_REPO_NAME}.git"

          git clone --depth 1 --branch $EXTERNAL_BRANCH --filter=blob:none --sparse --quiet $EXTERNAL_REPO_URL temp-repo
          cd temp-repo
          git sparse-checkout set "$EXTERNAL_FOLDER"

          if [ ! -d "$EXTERNAL_FOLDER" ]; then
            echo "错误：外部仓库 $EXTERNAL_REPO_NAME 的 $EXTERNAL_FOLDER 文件夹不存在！"
            exit 1
          fi

          for file in "$EXTERNAL_FOLDER"*; do
            filename=$(basename "$file")
            if [ -f "$TARGET_FOLDER/$filename" ] || [ -d "$TARGET_FOLDER/$filename" ]; then
              echo "警告：$filename 已存在于主博客 _publications/，跳过同步"
              continue
            fi
            cp -r "$file" "$TARGET_FOLDER"
            echo "成功同步：$filename → $TARGET_FOLDER"
          done

          cd ..
          rm -rf temp-repo

      # 关键修复：配置 Ruby 环境（自动安装 bundler 和对应 Ruby 版本）
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1  # 官方 Ruby 环境配置动作
        with:
          ruby-version: "3.3"  # 推荐使用 3.0+ 稳定版（Jekyll 兼容）
          bundler-cache: true  # 缓存依赖，加速后续构建（可选但推荐）

      # 修复后的构建步骤：现在能正常使用 bundle 命令
      - name: Build blog (Jekyll)
        run: |
          # 安装 Jekyll 及依赖（从 Gemfile 读取）
          bundle install --path vendor/bundle
          # 构建博客到 _site 目录
          bundle exec jekyll build

      # 3. 部署到 GitHub Pages（不变）
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
          commit_message: "Sync external publications: ${{ github.sha }}"
