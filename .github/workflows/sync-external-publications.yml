name: Sync External Repo to Publications Root
on:
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动同步（可调整频率）
  workflow_dispatch:  # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆主博客仓库（包含 _publications/ 目录）
      - name: Checkout main repo
        uses: actions/checkout@v4

      # 2. 拉取外部私有仓库的 notes/publications/ 文件夹，同步到主博客 _publications/ 根目录
      - name: Sync external notes/publications to _publications/
        run: |
          # 定义变量（方便后续修改）
          GITHUB_USERNAME="Jinpeng-Xin"  # 你的 GitHub 用户名（必须正确）
          EXTERNAL_REPO_NAME="jinpeng-xin"  # 外部私有仓库名（无需 .git 结尾）
          EXTERNAL_BRANCH="main"  # 外部仓库的目标分支（如 main/master 或 commit ID）
          # 关键修改：同步 notes 下的 publications 文件夹
          EXTERNAL_FOLDER="src/site/notes/publications/"
          TARGET_FOLDER="../_publications/"  # 主博客的目标路径（_publications/ 根目录）

          # 用 PAT 构建授权克隆链接（私有仓库必需，避免身份验证失败）
          EXTERNAL_REPO_URL="https://${GITHUB_USERNAME}:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/${GITHUB_USERNAME}/${EXTERNAL_REPO_NAME}.git"

          # 克隆外部私有仓库（指定分支、稀疏检出，只拉取需要的文件夹，速度更快）
          git clone --depth 1 --branch $EXTERNAL_BRANCH --filter=blob:none --sparse --quiet $EXTERNAL_REPO_URL temp-repo
          
          # 进入临时仓库，设置稀疏检出的目标文件夹（精确到 notes/publications/）
          cd temp-repo
          git sparse-checkout set "$EXTERNAL_FOLDER"
          
          # 验证外部文件夹是否存在，不存在则报错退出（避免白跑）
          if [ ! -d "$EXTERNAL_FOLDER" ]; then
            echo "错误：外部仓库 $EXTERNAL_REPO_NAME 的 $EXTERNAL_FOLDER 文件夹不存在！"
            exit 1
          fi
          
          # 复制 notes/publications/ 下的所有内容到主博客 _publications/ 根目录
          # 跳过同名文件，避免覆盖和 permalink 冲突
          for file in "$EXTERNAL_FOLDER"*; do
            filename=$(basename "$file")
            if [ -f "$TARGET_FOLDER/$filename" ] || [ -d "$TARGET_FOLDER/$filename" ]; then
              echo "警告：$filename 已存在于主博客 _publications/，跳过同步"
              continue
            fi
            cp -r "$file" "$TARGET_FOLDER"
            echo "成功同步：$filename → $TARGET_FOLDER"
          done
          
          # 清理临时文件，释放资源
          cd ..
          rm -rf temp-repo

      # 3. 构建并部署博客到 GitHub Pages
      - name: Build and deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
