name: Sync External Repo to Publications Root
on:
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动同步（可调整频率）
  workflow_dispatch:  # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 克隆主博客仓库（包含 _publications/ 目录）
      - name: Checkout main repo
        uses: actions/checkout@v4

      # 2. 拉取外部仓库的指定分支+文件夹，同步到主博客 _publications/ 根目录
      - name: Sync external papers to _publications/
        run: |
          # 定义变量（方便后续修改）
          EXTERNAL_REPO_URL="https://github.com/Jinpeng-Xin/jinpeng-xin.git"  # 外部仓库的克隆 URL（必须是 .git 结尾）
          EXTERNAL_BRANCH="main"  # 外部仓库的目标分支（根据实际情况修改，如 main/master）
          EXTERNAL_FOLDER="src/site/notes/papers/"  # 外部仓库中 papers/ 文件夹的完整路径（从仓库根目录开始）
          TARGET_FOLDER="../_publications/"  # 主博客的目标路径

          # 克隆外部仓库（指定分支，稀疏检出）
          git clone --depth 1 --branch $EXTERNAL_BRANCH --filter=blob:none --sparse $EXTERNAL_REPO_URL temp-repo
          
          # 进入临时仓库，设置稀疏检出的目标文件夹
          cd temp-repo
          git sparse-checkout set "$EXTERNAL_FOLDER"  # 精确指定外部仓库的 papers/ 路径
          
          # 验证外部文件夹是否存在，不存在则报错退出
          if [ ! -d "$EXTERNAL_FOLDER" ]; then
            echo "错误：外部仓库 $EXTERNAL_REPO_URL 的 $EXTERNAL_FOLDER 文件夹不存在！"
            exit 1  # 终止工作流，避免后续复制失败
          fi
          
          # 复制外部 papers/ 下的所有内容到主博客 _publications/ 根目录
          # 若外部 papers/ 下有子文件夹，会一并复制（保持目录结构）
          cp -r "$EXTERNAL_FOLDER"* "$TARGET_FOLDER"
          
          # 清理临时文件
          cd ..
          rm -rf temp-repo

      # 3. 构建并部署博客到 GitHub Pages
      - name: Build and deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          # 可选：若你的 GitHub Pages 部署分支不是 gh-pages，需指定（如主分支）
          # publish_branch: main
